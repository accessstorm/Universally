<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - {{ user.username }}</title>
    <!-- Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Preline UI Script - Ensure this path is correct for your setup -->
    <!-- If you installed via npm: <script src="./node_modules/preline/dist/preline.js"></script> -->
    <!-- Or use CDN if preferred and available -->
    <style>
        /* Improved styling for heatmap */
        .heatmap-wrapper { /* New wrapper for labels + grid */
             display: flex;
        }
        .heatmap-container {
            display: inline-block; /* Fit content */
            overflow-x: auto; /* Allow horizontal scrolling if needed */
            padding: 5px; /* Reduced padding */
        }
        .heatmap-grid {
            display: flex;
            flex-direction: row; /* Weeks horizontally */
            gap: 3px; /* Space between week columns */
        }
        .heatmap-week {
            display: flex;
            flex-direction: column; /* Days vertically */
            gap: 3px; /* Space between day squares */
        }
        .heatmap-square {
            width: 11px; /* Slightly smaller */
            height: 11px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 2px;
            background-color: #ebedf0; /* Default inactive color */
            cursor: default; /* Indicate non-interactive */
        }
        /* Activity Levels (adjust colors as needed) */
        .heatmap-square[data-level="1"] { background-color: #c6e48b; } /* Lighter green */
        .heatmap-square[data-level="2"] { background-color: #7bc96f; }
        .heatmap-square[data-level="3"] { background-color: #239a3b; }
        .heatmap-square[data-level="4"] { background-color: #196127; } /* Darker green */

        .heatmap-labels { /* Month labels container */
            display: flex;
            justify-content: space-between; /* Distribute labels */
            font-size: 0.75rem;
            color: #586069;
            margin-bottom: 5px;
            padding-left: 25px; /* Align with grid start */
        }
         .heatmap-labels > div { /* Individual month label */
             min-width: 40px; /* Ensure some space for short month names */
             text-align: center;
         }

        .heatmap-days { /* Day labels (Mon, Wed, Fri) */
            display: flex;
            flex-direction: column;
            gap: 3px; /* Match square gap */
            margin-right: 6px; /* Space between labels and grid */
            font-size: 0.7rem;
            color: #586069;
            padding-top: 16px; /* Align roughly with grid squares */
        }
        .heatmap-days span {
            height: 11px; /* Match square height */
            line-height: 11px; /* Center text vertically */
            visibility: hidden; /* Hide by default */
        }
        .heatmap-days span:nth-child(2), /* Mon (index 1) */
        .heatmap-days span:nth-child(4), /* Wed (index 3) */
        .heatmap-days span:nth-child(6) { /* Fri (index 5) */
             visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-4">Profile: {{ user.username }}</h1>

        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Current Streak</h2>
            <p class="text-3xl font-bold text-blue-600">
                <span id="current-streak">Loading...</span> days
            </p>
        </div>

        <div>
            <h2 class="text-xl font-semibold mb-2">Activity Heatmap (Last 6 Months)</h2>
            <!-- Wrapper for labels and grid -->
            <div class="heatmap-wrapper">
                 <!-- Day Labels (Sun-Sat) -->
                 <div class="heatmap-days">
                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                 </div>
                 <!-- Container for month labels and grid -->
                 <div>
                     <!-- Month Labels (Generated by JS) -->
                     <div id="heatmap-labels" class="heatmap-labels"></div>
                     <!-- Grid Container -->
                    <div id="heatmap-container" class="heatmap-container border border-gray-200 rounded">
                        Loading heatmap...
                    </div>
                 </div>
            </div>
        </div>
    </div>

     <!-- Preline Tooltip Element (Hidden) -->
     <div id="hs-tooltip-example" class="hs-tooltip hidden" role="tooltip">
       <div class="hs-tooltip-content hs-tooltip-shown:opacity-100 hs-tooltip-shown:visible opacity-0 transition-opacity inline-block absolute invisible z-10 py-1 px-2 bg-gray-900 text-xs font-medium text-white rounded shadow-sm dark:bg-slate-700" >
         Tooltip content
       </div>
     </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const heatmapContainer = document.getElementById('heatmap-container');
            const streakElement = document.getElementById('current-streak');
            const userActivityURL = "{% url 'users:activity_heatmap_data' %}"; // Get URL from Django template tag

            fetch(userActivityURL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Activity data:", data); // Log fetched data
                    streakElement.textContent = data.currentStreak !== null ? data.currentStreak : 0;
                    renderHeatmap(heatmapContainer, data.activityDates, data.startDate, data.endDate);
                    // Initialize Preline tooltips after rendering heatmap
                    setTimeout(() => { // Use timeout to ensure elements are in DOM
                        if (window.HSStaticMethods && typeof window.HSStaticMethods.autoInit === 'function') {
                             window.HSStaticMethods.autoInit(['tooltip']);
                             console.log("Preline tooltips initialized.");
                        } else {
                            console.warn("Preline UI (HSStaticMethods or autoInit) not found or not ready. Tooltips may not initialize.");
                        }
                    }, 100); // Small delay might help ensure Preline is ready
                })
                .catch(error => {
                    console.error('Error fetching activity data:', error);
                    heatmapContainer.textContent = 'Error loading heatmap data.';
                    streakElement.textContent = 'Error';
                });
        });

        function renderHeatmap(container, activityDates, startDateStr, endDateStr) {
            container.innerHTML = ''; // Clear loading message
            const labelsContainer = document.getElementById('heatmap-labels');
            labelsContainer.innerHTML = ''; // Clear old labels

            const activitySet = new Set(activityDates);
            const startDate = new Date(startDateStr + 'T00:00:00Z');
            const endDate = new Date(endDateStr + 'T00:00:00Z');

            // Adjust start date to the beginning of its week (Sunday=0)
            const startDayOfWeek = startDate.getUTCDay();
            startDate.setUTCDate(startDate.getUTCDate() - startDayOfWeek);

            const grid = document.createElement('div');
            grid.classList.add('heatmap-grid');

            let weekElement = null;
            let currentMonth = -1;
            let weekCount = 0;

            // Iterate through each day from adjusted start date to end date
            let loopDate = new Date(startDate);
            while (loopDate <= endDate) {
                const dayOfWeek = loopDate.getUTCDay(); // 0 = Sunday, 6 = Saturday
                const dateString = loopDate.toISOString().split('T')[0]; // YYYY-MM-DD
                const month = loopDate.getUTCMonth();

                // Start a new week column on Sunday
                if (dayOfWeek === 0) {
                    weekElement = document.createElement('div');
                    weekElement.classList.add('heatmap-week');
                    grid.appendChild(weekElement);
                    weekCount++;

                    // Add month label if it's the start of a new month (and not the very first week unless it starts mid-month)
                    if (month !== currentMonth) {
                         // Add label only if it's the first week of this month's display
                         if (loopDate.getUTCDate() <= 7 || weekCount <= 1) {
                            const monthLabel = document.createElement('div');
                            monthLabel.textContent = loopDate.toLocaleString('default', { month: 'short' });
                            labelsContainer.appendChild(monthLabel);
                         } else {
                             // Add placeholder for spacing if needed, or adjust styling
                             const placeholder = document.createElement('div');
                             labelsContainer.appendChild(placeholder);
                         }
                        currentMonth = month;
                    } else if (weekCount % 4 === 1 && weekCount > 1) { // Add labels roughly every 4 weeks otherwise
                         const monthLabel = document.createElement('div');
                         monthLabel.textContent = loopDate.toLocaleString('default', { month: 'short' });
                         labelsContainer.appendChild(monthLabel);
                    } else {
                         // Add placeholder for spacing
                         const placeholder = document.createElement('div');
                         labelsContainer.appendChild(placeholder);
                    }
                }

                // Create square for the day
                const square = document.createElement('div');
                square.classList.add('heatmap-square');
                square.dataset.date = dateString;

                // Add Preline tooltip attributes
                square.setAttribute('data-hs-tooltip-placement', 'top'); // Tooltip position
                square.setAttribute('data-hs-tooltip-content', dateString); // Tooltip content (the date)
                square.classList.add('hs-tooltip'); // Mark for Preline initialization

                // Set activity level (simple version: level 1 if active)
                if (activitySet.has(dateString)) {
                    square.dataset.level = "2"; // Use a mid-level green for any activity
                } else {
                    square.dataset.level = "0"; // Inactive
                }

                // Append square to the current week column
                if (weekElement) {
                    weekElement.appendChild(square);
                }

                // Move to the next day
                loopDate.setUTCDate(loopDate.getUTCDate() + 1);
            }

            // Append the fully constructed grid to the container
            container.appendChild(grid);
        }
    </script>
    <!-- Ensure Preline script is loaded -->
    <script src="./node_modules/preline/dist/preline.js"></script> 
</body>
</html>
